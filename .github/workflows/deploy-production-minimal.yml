name: ğŸš€ Deploy to Production (Minimal)

on:
  push:
    branches: [ main, fix-production-login-and-ui-redesign ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Production Server (Seeding Test)
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: ${{ secrets.PRODUCTION_PORT }}
        script: |
          echo "ğŸš€ Starting Minimal Production Deployment for Seeding Test..."
          
          # Navigate to application directory
          cd /var/www/salessync || { echo "âŒ Failed to navigate to app directory"; exit 1; }
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin fix-production-login-and-ui-redesign || { echo "âŒ Git pull failed"; exit 1; }
          
          # Backend deployment with seeding test
          echo "ğŸ”§ Deploying Backend..."
          cd backend
          
          # Clear Prisma cache
          echo "ğŸ§¹ Clearing Prisma cache..."
          rm -rf node_modules/.prisma
          rm -rf prisma/generated
          
          # Install dependencies (skip if taking too long)
          echo "ğŸ“¦ Installing backend dependencies..."
          timeout 300 npm ci || echo "âš ï¸ Backend dependencies timeout - using existing"
          
          # Generate Prisma client
          echo "ğŸ”„ Generating Prisma client..."
          npx prisma generate || { echo "âŒ Prisma generate failed"; exit 1; }
          
          # Test database seeding (THE MAIN TEST)
          echo "ğŸŒ± Testing database seeding..."
          if [ -f "prisma/seed-production-simple.ts" ]; then
            echo "âœ… Using seed-production-simple.ts"
            npx tsx prisma/seed-production-simple.ts || { echo "âŒ Seeding failed"; exit 1; }
          else
            echo "âŒ seed-production-simple.ts not found"
            exit 1
          fi
          
          # Restart backend service
          echo "ğŸ”„ Restarting backend service..."
          sudo systemctl restart salessync-backend || echo "âš ï¸ Backend restart failed"
          
          # Frontend deployment (minimal)
          echo "ğŸ¨ Deploying Frontend..."
          cd ../frontend
          
          # Install dependencies (skip if taking too long)
          echo "ğŸ“¦ Installing frontend dependencies..."
          timeout 300 npm ci || echo "âš ï¸ Frontend dependencies timeout - using existing"
          
          # Build frontend (skip if taking too long)
          echo "ğŸ—ï¸ Building frontend..."
          timeout 300 npm run build || echo "âš ï¸ Frontend build timeout - using existing"
          
          # Restart frontend service
          echo "ğŸ”„ Restarting frontend service..."
          sudo systemctl restart salessync-frontend || echo "âš ï¸ Frontend restart failed"
          
          # Restart containers if they exist
          echo "ğŸ³ Restarting containers..."
          if command -v docker &> /dev/null; then
            sudo docker-compose restart || echo "âš ï¸ Docker restart failed"
          fi
          
          echo "âœ… Minimal deployment completed!"
          echo "ğŸŒ± Seeding test: SUCCESS"
          
    - name: ğŸ“Š Deployment Status
      if: always()
      run: |
        echo "ğŸ¯ Deployment completed"
        echo "ğŸŒ± Main goal: Test seeding fix"
        
    - name: ğŸ“§ Notify on Failure
      if: failure()
      run: |
        echo "âŒ Minimal deployment failed"
        echo "ğŸ” Check seeding logs above"